{% extends "Base/base.html" %}
{% load staticfiles %}
{% load filtros %}

<!-- Activo en el menu: -->
{% block activaciones-li %} active {% endblock %}
{% block titulo %}{% if cliente == "" %}Activaciones{% else %}Cliente {{cliente.nombre}}{% endif %}{% endblock %}

{% block content %}
	<!-- Right Panel -->
	<div id="right-panel" class="right-panel">

		<header id="header" class="header">
			<div class="header-menu">

				<div class="col-12">
					<a id="menuToggle" class="menutoggle pull-left"><i class="fa fa fa-tasks"></i></a>
					<div class="header-left">
						<div class="page-header float-left">
							<div class="page-title">
								<h1>
									{% if cliente != "" %}
										{{cliente.nombre}}
										 / 
									{% endif %}
									Activaciones
								</h1>
							</div>
						</div>
					</div>
				</div>
<!--
				<div class="col-sm-4">
					<a id="menuToggle" class="menutoggle pull-left"><i class="fa fa fa-tasks"></i></a>
					<div class="header-left">

						<div class="page-header float-left">
							<div class="page-title">
								{% if cliente == "" %}
									<h1>Todas las Activaciones</h1>
								{% else %}
									<h1>Cliente {{cliente.nombre}}</h1>
								{% endif %}
							</div>
						</div>

					</div>
				</div>
				
				<div class="col-sm-8">
					<div class="breadcrumbs">
						<div class="page-header float-right">
							<div class="page-title">
								<ol class="breadcrumb text-right">
									{% if cliente != "" %}
										<li class="active">{{cliente.nombre}}</li>
									{% else %}
										<li class="active">Activaciones</li>
									{% endif %}
								</ol>
							</div>
						</div>
					</div>
				</div>
-->
			</div>
		</header>
<!--
		<div class="breadcrumbs">
			<div class="col-sm-6">
				<div class="page-header float-left">
					<div class="page-title">
						{% if cliente == "" %}
							<h1>Todas las Activaciones</h1>
						{% else %}
							<h1>Cliente {{cliente.nombre}}</h1>
						{% endif %}
					</div>
				</div>
			</div>
			<div class="col-sm-6">
				<div class="page-header float-right">
					<div class="page-title">
						<ol class="breadcrumb text-right">
							{% if cliente != "" %}
								<li class="active">{{cliente.nombre}}</li>
							{% else %}
								<li class="active">Activaciones</li>
							{% endif %}
						</ol>
					</div>
				</div>
			</div>
		</div>
-->
		<div class="content mt-3">
			<div class="animated fadeIn">
				<div class="row">
					<div class="col-lg-4 col-md-6 col-sm-8">
						<div class="card">
							<div class="card-body">
								<div class="stat-widget-one">
									<div class="stat-icon dib"><i class="ti-blackboard text-primary border-primary"></i></div> <!--success/primary/warning/danger   ti-layout-grid2 -->
									<div class="stat-content dib">
										<div class="stat-text">Activaciones totales</div>
										<div class="stat-digit">{{activaciones.count}}</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					
					<div class="col-lg-4 col-md-6 col-sm-8">
						<div class="card">
							<div class="card-body">
								<div class="stat-widget-one">
									<div class="stat-icon dib"><i class="ti-blackboard text-warning border-warning"></i></div>
									<div class="stat-content dib">
										<div class="stat-text">Activaciones pendientes</div>
										<div class="stat-digit">{{pendientes}}</div>
									</div>
								</div>
							</div>
						</div>
					</div>

					{% if cliente != "" %}
						<div class="col-lg-4 col-md-6 col-sm-8">
							<div class="card">
								<div class="card-body">
									<div class="stat-widget-one">
										<div class="stat-icon dib"><i class="ti-money text-success border-success"></i></div> <!--success/primary/warning/danger -->
										<div class="stat-content dib">
											<div class="stat-text">Venta total</div>
											<div class="stat-digit">{{venta}}</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					{% endif %}
					
				</div>


				
				
				


				<div class="row">
					<div class="col-md-12">
						<div class="card">
							<div class="card-header">
								<strong class="card-title">Activaciones</strong>
							</div>
							<div class="card-body">
								<div class="row">
									<div class="card-body">
										<button type="button" class="btn btn-outline-success" onclick="location.href='{% url "agregar_activacion" %}{% if cliente != "" %}?cliente={{cliente.idCliente}}{% endif %}'"><i class="fa fa-plus-circle"></i>&nbsp; Nueva activación</button>
										<button type="button" class="btn btn-outline-primary" onclick="mostrar()"><i class="ti-pencil-alt"></i>&nbsp; Editar activaciones</button>
									</div>
								</div>
					  <table id="bootstrap-data-table" class="table table-striped table-bordered">
						<thead>
						  <tr>
							{% for titulo in titulos %}
								<th>{{titulo}}</th>
							{% endfor %}
							<th>Facturas</th>
						  </tr>
						</thead>
						<tbody>
							{% for activacion in activaciones %}
								<tr>
									<th scope="row" id="td_{{activacion.idActivacion}}">
										{{activacion.idActivacion}}
										<a style="visibility:hidden" href='{% url "editar_activacion" %}?Activacion={{activacion.idActivacion}}{% if cliente != "" %}&cliente={{cliente.idCliente}}{% endif %}' ><i class="ti-pencil-alt text-primary"></i></a>
										<a style="visibility:hidden" href="javascript:void(0)" onclick="eliminar('{{activacion.nombre}}', '{{activacion.idActivacion}}');" ><i class="fa fa-minus-circle text-danger"></i></a>
									</th>
									{% if cliente == "" %}
										<td><a href="{% url 'activaciones' %}?cliente={{activacion.Cliente.idCliente}}" style="color:#007bff; text-decoration: underline;" >{{activacion.Cliente.nombre}}</a></td>
									{% endif %}
									<td><a href="{% url 'eventos' %}?Activacion={{activacion.idActivacion}}" style="color:#007bff; text-decoration: underline;" >{{activacion.nombre}}</a></td>
									<td>{{activacion.tipo}}</td>
									<td>{{activacion.monto}}</td>
									<td>{{activacion.descripcion}}</td>
									
									{% if activacion.monto == 0 %}
										<td bgcolor="#868e96"><b>Falta ingresar monto</b></td>
									{% elif activacion|facturado == "Si" and activacion|pagado == "Si" %}
										<td bgcolor="#28a745"><b>Facturado y pagado</b></td>
									{% else %}
										<td>
											<button {% if activacion|facturado == "Si" %} disabled {% endif %} type="button" class="btn btn-outline-primary" onclick="location.href='{% url "agregar_factura" %}?activacion={{activacion.idActivacion}}'"><i class="fa fa-money"></i>&nbsp; Facturar</button>
											<button id="btn_pagar_{{activacion.idActivacion}}" type="button" class="btn btn-outline-success" onclick="pagar('{{activacion.idActivacion}}', '{% for factura in activacion.Facturas.all %}{{factura.nFactura}}/{% endfor %}', '{% for ingreso in activacion.Ingresos.all %}{% if ingreso.Factura == None %}{{ingreso.idIngreso}} - ${{ingreso.monto}}/{% endif %}{% endfor %}')"><i class="fa fa-money"></i>&nbsp; Pagar</button>
										</td>
									{% endif %}
								</tr>
							{% endfor %}
						</tbody>
					  </table>
							</div>
						</div>
					</div>
				</div>

				{% if cliente != "" %}
					<div class="row">
						<div class="col-lg-4 col-md-6 col-sm-8">
							<div class="card">
								<div class="card-body">
									<div class="stat-widget-one">
										<div class="stat-icon dib"><i class="ti-user text-primary border-primary"></i></div>
										<div class="stat-content dib">
											<div class="stat-text">Contactos</div>
											<div class="stat-digit">{{contactos.count}}</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>

					

					<div class="row">
						<div class="col-md-12">
							<div class="card">
								<div class="card-header">
									<strong class="card-title">Contactos</strong>
								</div>
								<div class="card-body">
									<div class="row">
										<div class="card-body">
											<button type="button" class="btn btn-outline-success" onclick="location.href='{% url "agregar_contacto_select" %}?cliente={{cliente.idCliente}}'"><i class="fa fa-plus-circle"></i>&nbsp; Nuevo contacto</button>
											<button type="button" class="btn btn-outline-primary" onclick="mostrar2()"><i class="ti-pencil-alt"></i>&nbsp; Editar contactos</button>
										</div>
									</div>
						  <table id="bootstrap-data-table" class="table table-striped table-bordered">
							<thead>
							  <tr>
								{% for titulo in titulos_contactos %}
									<th scope="col">{{titulo}}</th>
								{% endfor %}
							  </tr>
							</thead>
							<tbody>
								{% for contacto in contactos %}
									<tr>
										<th scope="row" id="td_contacto_{{contacto.idContacto}}">
										{{contacto.idContacto}}
										<a style="visibility:hidden" href='{% url "editar_activacion" %}?Activacion={{activacion.idActivacion}}' ><i class="ti-pencil-alt text-primary"></i></a>
										<a style="visibility:hidden" href="javascript:void(0)" onclick="eliminar('{{activacion.nombre}}', '{{activacion.idActivacion}}');" ><i class="fa fa-minus-circle text-danger"></i></a>
									</th>
										<td>{{contacto.nombre}}</td>
										<!--<td>{{contacto.Cliente.nombre}}</td>-->
										<!--<td>{% if contacto.rut != None %}{{contacto.rut}}{% else %} - {% endif %}</td>-->
										<td>{% if contacto.telefono != None %}{{contacto.telefono}}{% else %} - {% endif %}</td>
										<td>{% if contacto.mail != None %}{{contacto.mail}}{% else %} - {% endif %}</td>
									</tr>
								{% endfor %}
							</tbody>
						  </table>
								</div>
							</div>
						</div>
					</div>
				{% endif %}

			</div><!-- .animated -->
		</div><!-- .content -->


	</div><!-- /#right-panel -->

	<!-- Right Panel -->


	<script type="text/javascript">
		var visible = false;
		function mostrar() {
			visible = !visible;
			var botones, i;
			{% for activacion in activaciones %}
				try {
					botones = document.getElementById("td_" + {{activacion.idActivacion}}).children;
					for (i=0; i<botones.length; i++) {
						//if (botones[i].style.visibility == "hidden") {
						if (visible) {
							botones[i].style.visibility = "visible";
						}
						else {
							botones[i].style.visibility = "hidden";
						}
					}
				}
				catch(err) {}
			{% endfor %}
		}

		var visible2 = false;
		function mostrar2() {
			visible2 =! visible2
			var botones, i;
			{% for contacto in contactos %}
				try {
					botones = document.getElementById("td_contacto_" + {{contacto.idContacto}}).children;
					for (i=0; i<botones.length; i++) {
						//if (botones[i].style.visibility == "hidden") {
						if (visible2) {
							botones[i].style.visibility = "visible";
						}
						else {
							botones[i].style.visibility = "hidden";
						}
					}
				}
				catch(err) {}
			{% endfor %}
		}
	</script>

	<button id="eliminar" type="button" style="display:none" class="btn btn-secondary mb-1" data-toggle="modal" data-target="#smallmodal">Small</button>

	<div class="modal fade" id="smallmodal" tabindex="-1" role="dialog" aria-labelledby="smallmodalLabel" aria-hidden="true">
		<div class="modal-dialog modal-md" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 id="h5_eliminar" class="modal-title" ></h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<p id="p_eliminar">
						
					</p>
				</div>
				<div class="modal-footer">
					<button id="boton_eliminar" type="button" onclick="" class="btn btn-danger" >Eliminar</button>
					<button type="button" class="btn btn-primary" data-dismiss="modal">Cancelar</button>
					
				</div>
			</div>
		</div>
	</div>

	
	<script>
		function eliminar(nombre, id) {
			document.getElementById("p_eliminar").innerHTML = "¿Estas seguro? Se eliminarán todos los eventos asociados.";
			document.getElementById("h5_eliminar").innerHTML = "Eliminar activación " + nombre;
			document.getElementById("boton_eliminar").onclick = function(){location.href='{% url "eliminar_activacion" %}?Activacion=' + id 
				{%if cliente != "" %} + "&cliente={{cliente.idCliente}}"{% endif %}
				};
			document.getElementById("eliminar").click();
		}
		function eliminar2(nombre, id) {
			document.getElementById("p_eliminar").innerHTML = "¿Estas seguro?";
			document.getElementById("h5_eliminar").innerHTML = "Eliminar contacto " + nombre;
			document.getElementById("boton_eliminar").onclick = function(){location.href='{% url "eliminar_contacto" %}?contacto=' + id};
			document.getElementById("eliminar").click();
		}
	</script>



	<button id="btn_pagar" type="button" style="display:none" class="btn btn-secondary mb-1" data-toggle="modal" data-target="#modal_pagar">Small</button>

	<div class="modal fade" id="modal_pagar" tabindex="-1" role="dialog" aria-labelledby="modal_pagarLabel" aria-hidden="true">
		<div class="modal-dialog modal-md" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" >Pagar activación</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<form id="pagar_form" method="post" >
					{% csrf_token %}
					<input type="hidden" name="activacion" id="activacion" value="" />
					<input type="hidden" name="asociar" id="input_asociar" value="False" />
					<div class="modal-body">
						<div class="row form-group">
	                        
	                        <div class="col-12"><label id="label_radios_factura" class=" form-control-label">¿Qué factura pagar?</label></div>
	                        <div class="col-12">
	                        	<div id="div_radios_factura" class="form-check" >
	                        <!--
	                           	<div class="radio">
	                              <label for="radio1" class="form-check-label ">
	                                <input type="radio" id="radio1" name="radios" value="option1" class="form-check-input">Option 1
	                              </label>
	                            </div>
	                        -->
	                        	</div>
	                        </div>

	                        <div class="col-12"><label id="label_ingresos" class=" form-control-label" style="display:none;" ><br><br>Existen pagos sin facturas asociadas en esta activación. ¿Deseas asociar uno de estos a alguna factura?</label></div>
	                        <div class="col-8">
	                           	<select name="ingreso" id="select_ingresos" class="form-control" style="display:none;">
	                                <!--<option value="0">Please select</option>
	                                <option value="1">Option #1</option>
	                                <option value="2">Option #2</option>
	                                <option value="3">Option #3</option>-->
	                            </select>
	                        </div>
	                        <div class="col-4">
	                        	<button id="btn_ingresos" type="button" class="btn btn-success" onclick="asociar_submit();" style="display:none;" ><i class="fa fa-link"></i>&nbsp; Asociar</button>
	                        </div>
	                        {% if mensaje_error != "" %}
	                        	<div class="col-12"><label class=" form-control-label" ><br><b>{{mensaje_error}}</b></label></div>
	                        {% endif %}
	                        <div class="col-12"><label id="label_ingresos2" class=" form-control-label" style="display:none;" ><br>En caso contrario puedes efectuar un nuevo pago.</label></div>

	                    </div>
					</div>
					<div class="modal-footer">
						<button type="submit" class="btn btn-success" ><i class="fa fa-money"></i>&nbsp; Pagar</button>
						<button type="button" class="btn btn-primary" data-dismiss="modal">Cancelar</button>
					</div>
				</form>
			</div>
		</div>
	</div>



	<script>
		function pagar(activacion, facturas, ingresos) {
			document.getElementById("activacion").value = activacion;
			var div_radios = document.getElementById('div_radios_factura');
			var facturas_list = facturas.split("/");
			div_radios.innerHTML = "";

			div_radios.innerHTML += '<div class="radio">' +
								'<label class="form-check-label ">' +
								'<input type="radio" id="radio_-" name="radios_factura" value="-" checked class="form-check-input">Ninguna (Adelanto)</label></div>';


			for (var i=0; i < facturas_list.length - 1; i++) {

				div_radios.innerHTML += '<div class="radio">' +
								'<label class="form-check-label ">' +
								'<input type="radio" id="radio_' + facturas_list[i] + '" name="radios_factura" value="' + facturas_list[i] + '" class="form-check-input">' + facturas_list[i] + '</label></div>';
			}
			{% if nFactura != "" %} document.getElementById("radio_{{nFactura}}").checked = true; {% endif %}



			var label_ingresos = document.getElementById('label_ingresos');
			label_ingresos.style.display = "none";
			var label_ingresos2 = document.getElementById('label_ingresos2');
			label_ingresos2.style.display = "none";
			var btn_ingresos = document.getElementById('btn_ingresos');
			btn_ingresos.style.display = "none";
			var select_ingresos = document.getElementById('select_ingresos');
			select_ingresos.style.display = "none";
			select_ingresos.innerHTML = "";
			if (ingresos != "") {
				var ingresos_list = ingresos.split("/");

				label_ingresos.style.display = "inline";
				label_ingresos2.style.display = "inline";
				btn_ingresos.style.display = "inline";
				select_ingresos.style.display = "inline";
				var ingreso;
				for (var i=0; i < ingresos_list.length - 1; i++) {
					ingreso = ingresos_list[i].split(" - ")[0];
					select_ingresos.innerHTML += '<option id="option_' + ingreso + '" value=' + ingreso + '>' + ingresos_list[i] + '</option>';
				}
				{% if idIngreso != "" %} document.getElementById("option_{{idIngreso}}").selected = true; {% endif %}
			}

			
			document.getElementById('btn_pagar').click();
		}

		function asociar_submit() {
			document.getElementById("input_asociar").value = "True";
			document.getElementById("pagar_form").submit();
		}
	</script>

	{% if mensaje_error != "" %}
		<script src="{% static 'assets/js/vendor/jquery-2.1.4.min.js' %}"></script>
		<script>
			$( document ).ready(function() {
			document.getElementById("btn_pagar_{{activacion}}").click();
			});
		</script>
	{% endif %}


{% endblock %}